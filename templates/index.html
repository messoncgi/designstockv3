<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapadura Stock</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- Estilos CSS Inalterados --- */
        :root {
            --cor-primaria: #FFA500; /* Laranja */
            --cor-primaria-hover: #FF8C00; /* Laranja Escuro */
            --cor-fundo: #1a1a1a; /* Preto/Cinza bem escuro */
            --cor-fundo-gradiente-inicio: #2a2a2a;
            --cor-fundo-gradiente-fim: #1a1a1a;
            --cor-card-fundo: rgba(40, 40, 40, 0.6); /* Fundo do card semi-transparente */
            --cor-card-borda: rgba(255, 165, 0, 0.2); /* Borda sutil laranja */
            --cor-texto: #f0f0f0; /* Texto claro */
            --cor-texto-secundario: #a0a0a0; /* Texto secundário/muted */
            --cor-sucesso: #28a745; /* Verde mantido para o botão interno */
            --cor-erro: #dc3545;
            --cor-aviso: #ffc107; /* Amarelo usado para o novo 'sucesso' */
            --cor-info: #17a2b8;
            --glow-cor: rgba(255, 165, 0, 0.7);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--cor-fundo-gradiente-inicio), var(--cor-fundo-gradiente-fim));
            background-attachment: fixed;
            color: var(--cor-texto);
            padding-top: 3rem;
            padding-bottom: 3rem;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container { flex-grow: 1; }
        .main-card { background-color: var(--cor-card-fundo); border: 1px solid var(--cor-card-borda); border-radius: 15px; padding: 2rem; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); margin-bottom: 2rem; }
        .main-title { color: var(--cor-primaria); text-align: center; margin-bottom: 1.5rem; font-weight: 700; }
        .nav-tabs { border-bottom: 1px solid var(--cor-card-borda); margin-bottom: 1.5rem; }
        .nav-tabs .nav-link { color: var(--cor-texto-secundario); background-color: transparent; border: none; border-bottom: 3px solid transparent; margin-right: 5px; padding: 0.8rem 1rem; transition: all 0.3s ease; font-weight: 500; }
        .nav-tabs .nav-link:hover { color: var(--cor-texto); border-bottom-color: rgba(255, 165, 0, 0.5); }
        .nav-tabs .nav-link.active { color: var(--cor-primaria); background-color: transparent; border-bottom: 3px solid var(--cor-primaria); font-weight: 700; }
        .upload-area { border: 1px solid var(--cor-card-borda); border-radius: 10px; padding: 2rem; text-align: center; margin: 20px 0; background-color: rgba(0, 0, 0, 0.1); transition: background-color 0.3s ease; }
        .upload-area:hover { background-color: rgba(0, 0, 0, 0.2); }
        .form-label { color: var(--cor-texto-secundario); margin-bottom: 0.5rem; display: block; }
        .form-control { background-color: rgba(255, 255, 255, 0.1); border: 1px solid var(--cor-card-borda); color: var(--cor-texto); border-radius: 8px; padding: 0.75rem 1rem; }
        .form-control::placeholder { color: var(--cor-texto-secundario); opacity: 0.7; }
        .form-control:focus { background-color: rgba(255, 255, 255, 0.15); border-color: var(--cor-primaria); box-shadow: 0 0 0 0.25rem rgba(255, 165, 0, 0.25); color: var(--cor-texto); }
        .btn-primary { background-color: var(--cor-primaria); border-color: var(--cor-primaria); color: var(--cor-fundo); padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .btn-primary:disabled { background-color: #6c757d; border-color: #6c757d; color: #ccc; cursor: not-allowed; box-shadow: none; opacity: 0.65; }
        .btn-primary:hover:not(:disabled),
        .btn-primary:focus:not(:disabled) { background-color: var(--cor-primaria-hover); border-color: var(--cor-primaria-hover); color: var(--cor-fundo); box-shadow: 0 0 15px 5px var(--glow-cor); }
        .btn-primary .loading { display: none; }
        .btn-primary .loading span { vertical-align: middle; }
        .btn-primary .loading .spinner-border { margin-right: 0.5em; }
        .btn-primary:disabled .loading { display: inline-block; }
        .btn-primary:disabled .normal-state { display: none; }
        .btn-primary .spinner-border { color: var(--cor-fundo); }
        .btn-primary:disabled .spinner-border { color: #ccc; }
        .tutorial-section { margin-top: 30px; padding: 20px; background-color: rgba(0, 0, 0, 0.1); border-radius: 10px; border-left: 4px solid var(--cor-primaria); }
        .tutorial-section h6 { color: var(--cor-primaria); margin-bottom: 15px; font-weight: 700; }
        .tutorial-section h6 i { margin-right: 8px; }
        .tutorial-step { margin-bottom: 10px; padding-left: 10px; color: var(--cor-texto-secundario); display: flex; align-items: center; }
        .tutorial-step i { margin-right: 10px; color: var(--cor-primaria); font-size: 1.1rem; min-width: 20px; text-align: center; }
        #uploadHistoryHeader { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        #uploadHistoryHeader h6 { color: var(--cor-texto-secundario); font-weight: 500; margin-bottom: 0; text-align: left; }
        #clearHistoryBtn { color: var(--cor-texto-secundario); border-color: var(--cor-texto-secundario); padding: 0.25rem 0.5rem; font-size: 0.8rem; opacity: 0.7; transition: all 0.3s ease; }
        #clearHistoryBtn:hover { color: var(--cor-erro); border-color: var(--cor-erro); background-color: rgba(220, 53, 69, 0.1); opacity: 1; }
        #clearHistoryBtn:disabled { opacity: 0.3; cursor: not-allowed; color: var(--cor-texto-secundario); border-color: var(--cor-texto-secundario); background-color: transparent; }
        #historyItems .card { position: relative; background-color: rgba(0, 0, 0, 0.15); border: 1px solid rgba(255, 255, 255, 0.1); border-left-width: 4px; border-radius: 8px; margin-bottom: 1rem; animation: fadeInSlideDown 0.5s ease-out forwards; overflow: hidden; }
        #historyItems .card .card-body.p-0 { padding: 0 !important; }
        #historyItems .card .card-body { padding: 1rem; color: var(--cor-texto); }
        #historyItems .alert { margin-bottom: 0; border-radius: 0 8px 8px 0; border: none; padding: 1rem; display: flex; align-items: center; }
        #historyItems .alert i { margin-right: 10px; font-size: 1.2rem; }
        .history-timestamp { position: absolute; top: 5px; right: 10px; font-size: 0.7rem; color: var(--cor-texto-secundario); opacity: 0.6; }
        @keyframes fadeInSlideDown { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }
        #historyItems .alert-success { background-color: rgba(255, 193, 7, 0.15); color: #ffeaa7; border-left: 4px solid var(--cor-aviso); }
        #historyItems .card.alert-success { border-color: var(--cor-aviso); }
        #historyItems .alert-success::before { content: "\F26A"; font-family: bootstrap-icons; margin-right: 10px; color: var(--cor-aviso); font-size: 1.2rem; }
        #historyItems .alert-success .btn-outline-primary { border-color: var(--cor-sucesso); color: var(--cor-sucesso); transition: all 0.3s ease; }
        #historyItems .alert-success .btn-outline-primary:hover { background-color: var(--cor-sucesso); color: var(--cor-fundo); }
        #historyItems .alert-danger { background-color: rgba(220, 53, 69, 0.2); color: #f8d7da; border-left: 4px solid var(--cor-erro); }
        #historyItems .card.alert-danger { border-color: var(--cor-erro); }
        #historyItems .alert-danger::before { content: "\F633"; font-family: bootstrap-icons; margin-right: 10px; color: var(--cor-erro); font-size: 1.2rem;}
        #historyItems .alert-warning { background-color: rgba(255, 193, 7, 0.2); color: #fff3cd; border-left: 4px solid var(--cor-aviso); }
        #historyItems .card.alert-warning { border-color: var(--cor-aviso); }
        #historyItems .alert-warning::before { content: "\F33B"; font-family: bootstrap-icons; margin-right: 10px; color: var(--cor-aviso); font-size: 1.2rem;}
        #historyItems .alert-info { background-color: rgba(23, 162, 184, 0.2); color: #d1ecf1; border-left: 4px solid var(--cor-info); }
        #historyItems .card.alert-info { border-color: var(--cor-info); }
        .history-item-pending .spinner-border { width: 1rem; height: 1rem; border-width: .2em; color: var(--cor-info); }
        .history-item-pending .text-muted { color: var(--cor-texto-secundario) !important; }
        .footer { margin-top: 3rem; padding: 1.5rem 0; border-top: 1px solid var(--cor-card-borda); color: var(--cor-texto-secundario); font-size: 0.9rem; text-align: center; }
        .footer-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; max-width: 800px; margin: 0 auto; padding: 0 15px; }
        .footer-brand { opacity: 0.7; margin-bottom: 10px; }
        .footer-made-with { margin-bottom: 10px; }
        .footer-made-with .text-danger { color: var(--cor-primaria) !important; }
        .footer-links a { color: var(--cor-texto-secundario); text-decoration: none; margin-left: 15px; transition: color 0.3s ease; }
        .footer-links a:hover { color: var(--cor-primaria); }
        .footer-links i { font-size: 1.2rem; vertical-align: middle; margin-right: 5px; }
        @media (max-width: 768px) { body { padding-top: 1.5rem; padding-bottom: 1.5rem; } .main-card { padding: 1.5rem; } .upload-area { padding: 1.5rem; } .nav-tabs .nav-link { padding: 0.6rem 0.8rem; } .btn-primary { padding: 0.6rem 1.2rem; } .footer-content { flex-direction: column; align-items: center; } .footer-brand, .footer-made-with, .footer-links { margin-bottom: 10px; } .footer-links a { margin-left: 10px; margin-right: 10px; } }

    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">

                <h1 class="main-title">Rapadura Stock <span class="badge bg-warning text-dark" style="font-size: 0.6em; vertical-align: middle;">BETA V1</span></h1>

                <div class="main-card">
                    <div class="card-body p-0">
                        <h5 class="card-title text-center mb-4" style="color: var(--cor-texto);">Baixe Arquivos Premium Grátis</h5>

                        <div id="userStatus" class="mb-3 px-3"> <div class="alert alert-secondary" style="background-color: rgba(255,255,255,0.1); border: none; color: var(--cor-texto-secundario);">Carregando status...</div>
                        </div>

                        <div class="px-3"> <ul class="nav nav-tabs" role="tablist">
                                <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#freepikTab" type="button" role="tab">Freepik</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#designiTab" type="button" role="tab">Designi</button></li>
                            </ul>

                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="freepikTab" role="tabpanel">
                                    <form id="uploadForm">
                                        <div class="upload-area">
                                            <div class="mb-3">
                                                <label for="freepik_link" class="form-label"><i class="bi bi-link-45deg"></i> Link do Freepik</label>
                                                <input type="text" class="form-control" id="freepik_link" name="freepik_link" placeholder="https://www.freepik.com/..." required>
                                            </div>
                                            <button type="submit" class="btn btn-primary">
                                                <span class="normal-state"><i class="bi bi-download"></i> Baixar Grátis</span>
                                                <span class="loading">
                                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processando...
                                                </span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                <div class="tab-pane fade" id="designiTab" role="tabpanel">
                                    <form id="designiForm">
                                        <div class="upload-area">
                                            <div class="mb-3">
                                                <label for="designi_link" class="form-label"><i class="bi bi-link-45deg"></i> Link do Designi</label>
                                                <input type="text" class="form-control" id="designi_link" placeholder="Cole aqui a URL do Designi..." required>
                                            </div>
                                             <button type="submit" class="btn btn-primary">
                                                <span class="normal-state"><i class="bi bi-download"></i> Baixar do Designi</span>
                                                 <span class="loading">
                                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processando...
                                                </span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div id="uploadHistory" class="mt-4 px-3">
                             <div id="uploadHistoryHeader">
                                 <h6>Histórico de Respostas</h6>
                                 <button id="clearHistoryBtn" class="btn btn-sm btn-outline-secondary" title="Limpar Histórico" disabled>
                                     <i class="bi bi-trash3-fill"></i> Limpar
                                 </button>
                             </div>
                            <div id="historyItems">
                                </div>
                        </div>

                        <div class="tutorial-section mx-3 mb-3"> <h6><i class="bi bi-info-circle-fill"></i> Como Funciona</h6>
                             <div class="tutorial-step"><i class="bi bi-input-cursor-text"></i> 1. Cole o link (Freepik ou Designi) no campo.</div>
                             <div class="tutorial-step"><i class="bi bi-mouse"></i> 2. Clique em "Baixar". Se o link for inválido, um aviso aparecerá.</div>
                             <div class="tutorial-step"><i class="bi bi-clock-history"></i> 3. <strong>Freepik:</strong> Se válido, aguarde ("Processando..."). O link aparecerá no histórico.</div>
                             <div class="tutorial-step"><i class="bi bi-hourglass-split"></i> 4. <strong>Designi:</strong> Se válido, aguarde ("Processando..."). O resultado final aparecerá no histórico.</div>
                             <div class="tutorial-step"><i class="bi bi-bar-chart-line-fill"></i> 5. <strong>Limite:</strong> Verifique seu status de downloads diários acima.</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-made-with">Feito com  <i class="bi bi-heart-fill text-danger"></i> e rapadura </div>
            <div class="footer-links">
                <a href="https://www.instagram.com/rapadurastock/" target="_blank" title="Instagram Rapadura Stock">
                    <i class="bi bi-instagram"></i> Instagram
                </a>
                <a href="mailto:suporte@rapadurastock.com" title="Suporte por E-mail">
                    <i class="bi bi-envelope-fill"></i> Suporte
                </a>
            </div>
            <div class="footer-brand">Rapadura Stock - BETA V1</div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const activePolls = {};
        const HISTORY_KEY = 'rapaduraStockHistory';
        const MAX_HISTORY_ITEMS = 20;

        // --- Mensagens divertidas (Inalterado) ---
        const mensagensFun = [ /* ... Manteve as mensagens ... */ ];
        function getMensagemFun() { /* ... Manteve a função ... */ }

        // --- Funções de Histórico (localStorage, formatTimestamp, renderHistoryItem, loadHistoryFromStorage, toggleClearHistoryButton) ---
        // --- Mantidas exatamente como na versão anterior ---
        function getHistory() { const storedHistory = localStorage.getItem(HISTORY_KEY); return storedHistory ? JSON.parse(storedHistory) : []; }
        function saveHistory(historyArray) { const limitedHistory = historyArray.slice(0, MAX_HISTORY_ITEMS); localStorage.setItem(HISTORY_KEY, JSON.stringify(limitedHistory)); toggleClearHistoryButton(); }
        function updateHistoryItemInStorage(itemId, newHtml) { let history = getHistory(); const itemIndex = history.findIndex(item => item.id === itemId); if (itemIndex > -1) { history[itemIndex].html = newHtml; saveHistory(history); } }
        function addHistoryItemToStorage(itemData) { let history = getHistory(); history.unshift(itemData); saveHistory(history); }
        function formatTimestamp(isoString) { if (!isoString) return ''; try { const date = new Date(isoString); return date.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); } catch (e) { console.error("Erro ao formatar timestamp:", e); return ''; } }
        function renderHistoryItem(itemData) { const historyDiv = document.getElementById('historyItems'); if (!historyDiv || !itemData || !itemData.html) return null; const newHistoryItem = document.createElement('div'); newHistoryItem.className = 'card mb-3 history-item'; if (itemData.id) { newHistoryItem.id = `history-item-${itemData.id}`; } const timestampHtml = `<span class="history-timestamp">${formatTimestamp(itemData.timestamp)}</span>`; const isAlert = itemData.html.includes('class="alert '); if (isAlert) { if (itemData.html.includes('alert-success')) newHistoryItem.classList.add('alert-success'); else if (itemData.html.includes('alert-danger')) newHistoryItem.classList.add('alert-danger'); else if (itemData.html.includes('alert-warning')) newHistoryItem.classList.add('alert-warning'); else if (itemData.html.includes('alert-info')) newHistoryItem.classList.add('alert-info'); newHistoryItem.innerHTML = `<div class="card-body p-0">${itemData.html}${timestampHtml}</div>`; } else { newHistoryItem.innerHTML = `<div class="card-body">${itemData.html}${timestampHtml}</div>`; } historyDiv.appendChild(newHistoryItem); return newHistoryItem; }
        function loadHistoryFromStorage() { const history = getHistory(); const historyDiv = document.getElementById('historyItems'); if(historyDiv) historyDiv.innerHTML = ''; history.forEach(itemData => renderHistoryItem(itemData)); toggleClearHistoryButton(); }
        function toggleClearHistoryButton() { const clearBtn = document.getElementById('clearHistoryBtn'); if (clearBtn) { const history = getHistory(); clearBtn.disabled = history.length === 0; } }


        // --- Função para atualizar display do status (Inalterado) ---
        function updateStatusDisplay(statusHtml) { /* ... Manteve a função ... */ }

        // --- Função para buscar e atualizar status (Inalterado) ---
        async function fetchAndUpdateStatus() { /* ... Manteve a função ... */ }

        // --- Função para adicionar item ao histórico (Inalterado desde a última versão) ---
        function addHistoryItem(contentHtml, itemId = null) {
            const timestamp = new Date().toISOString();
            const itemData = { html: contentHtml, id: itemId, timestamp: timestamp };
            const historyDiv = document.getElementById('historyItems');
            if (!historyDiv) return null;

            const newHistoryItem = document.createElement('div');
            newHistoryItem.className = 'card mb-3 history-item';
            if (itemData.id) { newHistoryItem.id = `history-item-${itemData.id}`; }

            const timestampHtml = `<span class="history-timestamp">${formatTimestamp(itemData.timestamp)}</span>`;
            const isAlert = itemData.html.includes('class="alert ');

            if (isAlert) {
                 if (itemData.html.includes('alert-success')) newHistoryItem.classList.add('alert-success');
                 else if (itemData.html.includes('alert-danger')) newHistoryItem.classList.add('alert-danger');
                 else if (itemData.html.includes('alert-warning')) newHistoryItem.classList.add('alert-warning');
                 else if (itemData.html.includes('alert-info')) newHistoryItem.classList.add('alert-info');
                newHistoryItem.innerHTML = `<div class="card-body p-0">${itemData.html}${timestampHtml}</div>`;
            } else {
                newHistoryItem.innerHTML = `<div class="card-body">${itemData.html}${timestampHtml}</div>`;
            }

            historyDiv.insertBefore(newHistoryItem, historyDiv.firstChild);
            addHistoryItemToStorage(itemData);
            return newHistoryItem;
        }

        // --- Função para reabilitar botão (Helper - Inalterado) ---
        function enableButton(button) { /* ... Manteve a função ... */ }

        // --- Função de Polling (Inalterado desde a última versão) ---
        function pollJobStatus(jobId) { /* ... Manteve a função ... */ }

        // --- Validação de Link (Função Auxiliar) ---
        // Verifica se o link é minimamente válido (começa com http e contém domínio)
        function isLinkValid(link, validDomains) {
            if (!link) return false;
            const lowerLink = link.toLowerCase();
            if (!lowerLink.startsWith('http://') && !lowerLink.startsWith('https://')) {
                return false;
            }
            return validDomains.some(domain => lowerLink.includes(domain));
        }

        // --- Event Listener Formulário Freepik (Validação no Clique) ---
        document.getElementById('uploadForm').addEventListener('submit', async function(event) {
            event.preventDefault(); // Previne envio padrão
            const form = this;
            const linkInput = document.getElementById('freepik_link');
            const link = linkInput.value.trim();
            const submitButton = form.querySelector('button[type="submit"]');
            const normalState = submitButton.querySelector('.normal-state');
            const loadingState = submitButton.querySelector('.loading');
            const freepikDomains = ['freepik.com'];

            // 1. Validar o link ANTES de fazer qualquer coisa
            if (!isLinkValid(link, freepikDomains)) {
                addHistoryItem('<div class="alert alert-warning mb-0">⚠️ Por favor, insira um link válido do Freepik (ex: https://www.freepik.com/...).</div>');
                // Não desabilita o botão, não mostra loading, apenas retorna
                return;
            }

            // 2. Se o link for válido, prosseguir com o processo
            submitButton.disabled = true;
            normalState.style.display = 'none';
            loadingState.style.display = 'inline-block'; // Mostra "Processando..."

            try {
                const response = await fetch('/upload', { method: 'POST', body: new FormData(form) });
                const dataHtml = await response.text();
                addHistoryItem(dataHtml); // Adiciona resultado (sucesso/erro do backend)
                if (response.ok) {
                    linkInput.value = ''; // Limpa input se backend respondeu OK
                }
                await fetchAndUpdateStatus();
            } catch (error) {
                console.error('Erro fetch /upload:', error);
                 const errorHtml = `<div class="alert alert-danger mb-0">Erro de comunicação com o servidor: ${error.message}</div>`;
                addHistoryItem(errorHtml);
                await fetchAndUpdateStatus();
            } finally {
                 // Reabilita o botão SEMPRE ao final do processo
                 enableButton(submitButton);
            }
        });

        // --- Event Listener Formulário Designi (Validação no Clique) ---
         document.getElementById('designiForm').addEventListener('submit', async function(event) {
            event.preventDefault(); // Previne envio padrão
            const form = this;
            const linkInput = document.getElementById('designi_link');
            const link = linkInput.value.trim();
            const submitButton = form.querySelector('button[type="submit"]');
            const normalState = submitButton.querySelector('.normal-state');
            const loadingState = submitButton.querySelector('.loading');
            const designiDomains = ['designi.']; // Verificação flexível

            // 1. Validar o link ANTES de fazer qualquer coisa
            if (!isLinkValid(link, designiDomains)) {
                addHistoryItem('<div class="alert alert-warning mb-0">⚠️ Por favor, insira um link válido do Designi.</div>');
                 // Não desabilita o botão, não mostra loading, apenas retorna
                return;
            }

            // 2. Se o link for válido, prosseguir com o processo
            submitButton.disabled = true;
            normalState.style.display = 'none';
            loadingState.style.display = 'inline-block'; // Mostra "Processando..."

            try {
                const response = await fetch('/download-designi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: link })
                });
                const data = await response.json();

                if (response.ok && data.success && data.job_id) {
                    // Adiciona mensagem inicial e inicia polling
                    // O botão permanecerá desabilitado até o polling terminar
                    const initialMsgHtml = `<div class="alert alert-info mb-0"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ${data.message || 'Processo iniciado...'} <span class="text-muted small">(ID: ${data.job_id})</span></div>`;
                    addHistoryItem(initialMsgHtml, data.job_id);
                    linkInput.value = '';
                    pollJobStatus(data.job_id); // pollJobStatus cuidará de reabilitar o botão
                } else {
                    // Erro ao iniciar o job no backend
                    const errorHtml = `<div class="alert alert-danger mb-0">Erro ao iniciar download: ${data.error || `Erro ${response.status}. Verifique o link.`}</div>`;
                    addHistoryItem(errorHtml);
                    enableButton(submitButton); // Reabilita botão se falhou ao iniciar
                    await fetchAndUpdateStatus();
                }
            } catch (error) {
                // Erro de rede ao tentar iniciar o job
                console.error('Erro fetch /download-designi:', error);
                const errorHtml = `<div class="alert alert-danger mb-0">Erro de comunicação com o servidor: ${error.message}</div>`;
                addHistoryItem(errorHtml);
                enableButton(submitButton); // Reabilita botão em erro de rede
                await fetchAndUpdateStatus();
            }
             // Removido finally daqui, pois o botão só deve ser reabilitado
             // se o polling não iniciar ou se der erro na comunicação inicial.
             // Se o polling iniciar, ele é responsável por reabilitar.
        });


        // --- Limpar Histórico (Inalterado) ---
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        if (clearHistoryBtn) {
            clearHistoryBtn.addEventListener('click', () => {
                if (confirm('Tem certeza que deseja limpar todo o histórico de downloads?')) {
                    const historyDiv = document.getElementById('historyItems');
                    if(historyDiv) historyDiv.innerHTML = '';
                    localStorage.removeItem(HISTORY_KEY);
                    toggleClearHistoryButton();
                }
            });
        }

        // --- Inicialização (Remove validação inicial dos inputs) ---
        window.addEventListener('DOMContentLoaded', () => {
            fetchAndUpdateStatus();
            loadHistoryFromStorage();
            // Botões agora começam habilitados (removido disabled do HTML)
            // Não precisamos mais validar/desabilitar no início.
        });

    </script>
</body>
</html>
