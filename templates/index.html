<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapadura Stok | Baixe arquivos premium gratuitamente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #f97316;
            --primary-dark: #ea580c;
            --secondary: #16a34a;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray: #94a3b8;
            --success: #16a34a;
            --warning: #d97706;
            --error: #dc2626;
            --info: #2563eb;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 47% 33%, hsl(222.18, 47%, 11%) 0, transparent 59%), 
                radial-gradient(at 82% 65%, hsl(22, 78%, 19%) 0, transparent 55%);
            color: var(--light);
            min-height: 100vh;
        }
        
        .glass-container {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
            transition: all 0.3s ease;
        }

        .glass-container:hover {
            border-color: rgba(249, 115, 22, 0.3);
            box-shadow: 0 8px 32px 0 rgba(249, 115, 22, 0.1);
        }
        
        .form-control {
            background-color: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--light);
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.3);
            background-color: rgba(15, 23, 42, 0.7);
        }
        
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: 12px;
            padding: 14px 24px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(249, 115, 22, 0.2);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .history-item {
            background: rgba(15, 23, 42, 0.6);
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(249, 115, 22, 0.15);
        }
        
        .alert {
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: none;
        }
        
        .alert-success {
            background-color: rgba(22, 163, 74, 0.15);
            color: #16a34a;
        }
        
        .alert-info {
            background-color: rgba(37, 99, 235, 0.15);
            color: #2563eb;
        }
        
        .alert-warning {
            background-color: rgba(217, 119, 6, 0.15);
            color: #d97706;
        }
        
        .alert-danger {
            background-color: rgba(220, 38, 38, 0.15);
            color: #dc2626;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 99px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-remaining {
            background: rgba(22, 163, 74, 0.15);
            color: var(--success);
        }
        
        .status-limit {
            background: rgba(220, 38, 38, 0.15);
            color: var(--error);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); }
            100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .platform-icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            filter: brightness(0) invert(1);
        }
    </style>
</head>
<body class="antialiased">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <div class="container mx-auto px-4 py-12 max-w-4xl">
        <!-- Header -->
        <header class="mb-10 text-center">
            <div class="flex items-center justify-center mb-4">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-3">
                    <path d="M12 2L3 7L12 12L21 7L12 2Z" stroke="#f97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    <path d="M3 17L12 22L21 17" stroke="#f97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    <path d="M3 12L12 17L21 12" stroke="#f97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-orange-400 to-orange-600 bg-clip-text text-transparent">Rapadura Stock</h1>
            </div>
            <p class="text-lg text-gray-400">Baixe arquivos premium de forma gratuita e rápida</p>
        </header>

        <div class="space-y-8">
            <!-- User Status -->
            <div id="userStatus">
                <div class="glass-container p-5">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="bg-orange-500/20 p-3 rounded-lg mr-4">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-orange-400">
                                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium text-gray-300">Seu status diário</h3>
                                <p class="text-gray-400">Carregando informações...</p>
                            </div>
                        </div>
                        <div class="status-badge">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-1">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Freepik Download Section -->
            <div class="glass-container p-6">
                <div class="flex items-center mb-5">
                    <img src="https://freepik.cdnpk.net/img/logo-freepik.svg" alt="Freepik" class="platform-icon">
                    <h3 class="text-xl font-semibold">Download do Freepik</h3>
                </div>
                
                <form id="freepikForm" class="mb-3">
                    <div class="mb-4">
                        <label for="freepik_link" class="block text-sm font-medium text-gray-300 mb-2">Cole o link do Freepik</label>
                        <input type="text" class="form-control w-full" id="freepik_link" name="freepik_link" placeholder="https://www.freepik.com/photo/12345678.htm" required>
                    </div>
                    <button type="submit" class="btn-primary w-full">
                        <span class="normal-state flex items-center justify-center">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Baixar Grátis
                        </span>
                        <span class="loading hidden items-center justify-center">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                            Processando...
                        </span>
                    </button>
                </form>
            </div>

            <!-- Designi Download Section -->
            <div class="glass-container p-6">
                <div class="flex items-center mb-5">
                    <img src="https://designistampas.com.br/wp-content/uploads/2020/06/cropped-horizonatalz-192x192.png" alt="Designi" class="platform-icon">
                    <h3 class="text-xl font-semibold">Download do Designi</h3>
                </div>

                <form id="designiForm" class="mb-3">
                    <div class="mb-4">
                        <label for="designi_link" class="block text-sm font-medium text-gray-300 mb-2">Cole o link do Designi</label>
                        <input type="text" class="form-control w-full" id="designi_link" placeholder="https://designistampas.com.br/produto/..." required>
                    </div>
                    <button type="submit" class="btn-primary w-full">
                        <span class="normal-state flex items-center justify-center">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Baixar Grátis
                        </span>
                        <span class="loading hidden items-center justify-center">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                            Processando...
                        </span>
                    </button>
                </form>
            </div>

            <!-- History Section -->
            <div>
                <div class="flex items-center justify-between mb-4 px-2">
                    <h3 class="text-xl font-semibold text-white">Histórico de Downloads</h3>
                    <span class="text-sm text-gray-400">Últimas 24 horas</span>
                </div>
                
                <div id="historyItems" class="space-y-3">
                    <div class="history-item">
                        <div class="p-4">
                            <div class="alert alert-info flex items-start">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2 flex-shrink-0 mt-1">
                                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <div>
                                    <p class="font-medium">Nenhum histórico recente</p>
                                    <p class="text-sm opacity-80">Seus downloads aparecerão aqui</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="flex items-center justify-between text-sm text-gray-500 mt-12">
            <div class="flex items-center">
                <span>Feito com</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="text-red-500 mx-1">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" stroke-width="0" fill="currentColor"></path>
                </svg>
                <span>por Rapadura Stok</span>
            </div>
            <div class="flex items-center">
                <span>BETA</span>
                <span class="bg-orange-500/20 text-orange-400 text-xs px-2 py-1 rounded-full ml-2">v2.0.0</span>
            </div>
        </footer>
    </div>

    <script>
        const activePolls = {};

        // Mensagens divertidas para limite atingido
        const mensagensFun = [
            "Parece que você está ansioso(a) para baixar! Limite diário atingido, volte amanhã!",
            "Você já conseguiu todos os downloads de hoje. Excelente trabalho!",
            "Calma, calma! O limite diário foi alcançado. Até amanhã!",
            "Boom! Você explodiu o limite diário de downloads.",
            "2 downloads já foram conquistados hoje. Amanhã tem mais!"
        ];
        
        function getMensagemFun() {
            return mensagensFun[Math.floor(Math.random() * mensagensFun.length)];
        }

        // Mostrar loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        // Esconder loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Atualiza o display do status
        function updateStatusDisplay(statusHtml) {
            const userStatus = document.getElementById('userStatus');
            if (!userStatus) return;

            // Se o HTML contém a mensagem de limite atingido
            if (statusHtml.includes("Você atingiu o limite")) {
                const mensagemFun = getMensagemFun();
                userStatus.innerHTML = `
                    <div class="glass-container p-5">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="bg-red-500/20 p-3 rounded-lg mr-4">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-red-400">
                                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-300">Status de downloads</h3>
                                    <p class="text-gray-400">${mensagemFun}</p>
                                </div>
                            </div>
                            <div class="status-badge status-limit">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-1">
                                    <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>Limite</span>
                            </div>
                        </div>
                    </div>`;
            } else {
                // Se não atingiu o limite, usa o HTML recebido do backend
                userStatus.innerHTML = `
                <div class="glass-container p-5">
                    ${statusHtml}
                </div>`;
            }
        }

        // Função para buscar e atualizar status
        async function fetchAndUpdateStatus() {
            try {
                showLoading();
                const response = await fetch('/status');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.text();
                updateStatusDisplay(data);
            } catch (error) {
                console.error('Erro ao carregar status:', error);
                const userStatus = document.getElementById('userStatus');
                if(userStatus) userStatus.innerHTML = `
                    <div class="glass-container p-5">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="bg-red-500/20 p-3 rounded-lg mr-4">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-red-400">
                                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-300">Status de downloads</h3>
                                    <p class="text-gray-400">Erro ao carregar status do servidor</p>
                                </div>
                            </div>
                            <div class="status-badge status-limit">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-1">
                                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>Erro</span>
                            </div>
                        </div>
                    </div>`;
            } finally {
                hideLoading();
            }
        }

        // Adiciona item ao histórico
        function addHistoryItem(contentHtml, itemId = null) {
            const historyDiv = document.getElementById('historyItems');
            
            // Remove o placeholder se existir
            if (historyDiv.children.length === 1 && 
                historyDiv.firstElementChild.querySelector('.alert-info')) {
                historyDiv.innerHTML = '';
            }
            
            const newHistoryItem = document.createElement('div');
            newHistoryItem.className = 'history-item glass-container p-0';
            if (itemId) { 
                newHistoryItem.id = `history-item-${itemId}`; 
            }
            
            newHistoryItem.innerHTML = `
                <div class="p-4">
                    ${contentHtml}
                </div>`;
            
            historyDiv.insertBefore(newHistoryItem, historyDiv.firstChild);
            return newHistoryItem;
        }

        // Verifica o status do job periodicamente
        function pollJobStatus(jobId) {
            console.log(`[POLL] Iniciando polling para Job ID: ${jobId}`);
            const historyItem = document.getElementById(`history-item-${jobId}`);
            if (!historyItem) { 
                console.error(`[POLL] Item histórico ${jobId} não encontrado.`); 
                return; 
            }
            
            const intervalId = setInterval(async () => {
                try {
                    console.log(`[POLL] Verificando ${jobId}...`);
                    const response = await fetch(`/check_job/${jobId}`);
                    
                    if (!response.ok) {
                        console.error(`[POLL] Erro ${response.status} verificar ${jobId}. Parando.`);
                        historyItem.innerHTML = `
                            <div class="alert alert-danger">
                                <div class="flex items-start">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2 flex-shrink-0 mt-1">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <div>
                                        <p class="font-medium">Erro ao verificar status</p>
                                        <p class="text-sm opacity-80">Código: ${response.status}</p>
                                    </div>
                                </div>
                            </div>`;
                        clearInterval(intervalId); 
                        delete activePolls[jobId]; 
                        return;
                    }
                    
                    const data = await response.json();
                    console.log(`[POLL] Status ${jobId}:`, data);
                    
                    if (data.status === 'finished') {
                        console.log(`[POLL] Job ${jobId} concluído!`); 
                        clearInterval(intervalId); 
                        delete activePolls[jobId];
                        
                        if (data.result && data.result.success) {
                            const result = data.result;
                            const successHtml = `
                                <div class="alert alert-success">
                                    <div class="flex items-start">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2 flex-shrink-0 mt-1">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M22 4L12 14.01l-3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <div>
                                            <p class="font-medium">Download concluído com sucesso!</p>
                                            <p class="text-sm opacity-80">Arquivo: ${result.filename || 'N/A'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <a href="${result.download_link}" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-500/10 border border-blue-500/20 rounded-lg text-blue-400 hover:bg-blue-500/20 transition">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Baixar arquivo
                                </a>
                            </div>`;
                        historyItem.innerHTML = successHtml;
                        } else { 
                            historyItem.innerHTML = `
                                <div class="alert alert-warning">
                                    <div class="flex items-start">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2 flex-shrink-0 mt-1">
                                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <div>
                                            <p class="font-medium">Falha no processamento</p>
                                            <p class="text-sm opacity-80">${data.result?.error || data.error || 'Erro desconhecido.'}</p>
                                        </div>
                                    </div>
                                </div>`;
                        }
                    } else if (data.status === 'failed') {
                        console.log(`[POLL] Job ${jobId} falhou!`); 
                        clearInterval(intervalId); 
                        delete activePolls[jobId];
                        historyItem.innerHTML = `
                            <div class="alert alert-danger">
                                <div class="flex items-start">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2 flex-shrink-0 mt-1">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <div>
                                        <p class="font-medium">Falha crítica</p>
                                        <p class="text-sm opacity-80">${data.error || 'Erro desconhecido.'}</p>
                                    </div>
                                </div>
                            </div>`;
                    } else { 
                        console.log(`[POLL] Job ${jobId} status: ${data.status}. Continuando...`); 
                    }
                } catch (error) {
                    console.error(`[POLL] Erro rede polling ${jobId}:`, error);
                    historyItem.innerHTML = `
                        <div class="alert alert-danger">
                            <div class="flex items-start">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2 flex-shrink-0 mt-1">
                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <div>
                                    <p class="font-medium">Erro de comunicação</p>
                                    <p class="text-sm opacity-80">Não foi possível verificar o status do download</p>
                                </div>
                            </div>
                        </div>`;
                    clearInterval(intervalId); 
                    delete activePolls[jobId];
                }
            }, 7000);
            
            activePolls[jobId] = intervalId;
            
            setTimeout(() => {
                if (activePolls[jobId]) {
                    console.warn(`[POLL] Timeout máximo ${jobId}. Parando.`); 
                    clearInterval(activePolls[jobId]); 
                    delete activePolls[jobId];
                    if (historyItem.classList.contains('history-item-pending')) { 
                        historyItem.innerHTML = `
                            <div class="alert alert-warning">
                                <div class="flex items-start">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2 flex-shrink-0 mt-1">
                                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <div>
                                        <p class="font-medium">Tempo limite excedido</p>
                                        <p class="text-sm opacity-80">Verifique o Google Drive para o arquivo</p>
                                    </div>
                                </div>
                            </div>`; 
                    }
                }
            }, 30 * 60 * 1000);
        }

        // Inicializa a página
        document.addEventListener('DOMContentLoaded', function() {
            // Carrega o status do usuário
            fetchAndUpdateStatus();
            
            // Configura o formulário do Freepik
            const freepikForm = document.getElementById('freepikForm');
            if (freepikForm) {
                freepikForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const freepikLink = document.getElementById('freepik_link').value.trim();
                    if (!freepikLink) return;
                    
                    try {
                        // Mostra estado de carregamento
                        const submitBtn = freepikForm.querySelector('button[type="submit"]');
                        submitBtn.disabled = true;
                        submitBtn.querySelector('.normal-state').classList.add('hidden');
                        submitBtn.querySelector('.loading').classList.remove('hidden');
                        
                        // Envia requisição
                        const response = await fetch('/download_freepik', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ url: freepikLink })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            console.log('[FREEPIK] Job iniciado:', data);
                            
                            // Adiciona ao histórico
                            const historyItem = addHistoryItem(`
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <img src="https://freepik.cdnpk.net/img/logo-freepik.svg" alt="Freepik" class="platform-icon w-5 h-5 mr-2">
                                        <div>
                                            <p class="font-medium">Processando download</p>
                                            <p class="text-sm opacity-80 truncate max-w-xs">${freepikLink}</p>
                                        </div>
                                    </div>
                                    <div class="animate-pulse flex space-x-1">
                                        <div class="w-2 h-2 bg-orange-400 rounded-full"></div>
                                        <div class="w-2 h-2 bg-orange-400 rounded-full"></div>
                                        <div class="w-2 h-2 bg-orange-400 rounded-full"></div>
                                    </div>
                                </div>
                            `, data.job_id);
                            
                            historyItem.classList.add('history-item-pending');
                            
                            // Inicia polling
                            pollJobStatus(data.job_id);
                            
                            // Limpa o formulário
                            document.getElementById('freepik_link').value = '';
                            
                        } else {
                            console.error('[FREEPIK] Erro:', data);
                            addHistoryItem(`
                                <div class="alert alert-danger">
                                    <div class="flex items-start">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2 flex-shrink-0 mt-1">
                                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <div>
                                            <p class="font-medium">Erro ao iniciar download</p>
                                            <p class="text-sm opacity-80">${data.error || 'Erro desconhecido'}</p>
                                        </div>
                                    </div>
                                </div>
                            `);
                        }
                    } catch (error) {
                        console.error('[FREEPIK] Erro de rede:', error);
                        addHistoryItem(`
                            <div class="alert alert-danger">
                                <div class="flex items-start">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2 flex-shrink-0 mt-1">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <div>
                                        <p class="font-medium">Erro de conexão</p>
                                        <p class="text-sm opacity-80">Não foi possível conectar ao servidor</p>
                                    </div>
                                </div>
                            </div>
                        `);
                    } finally {
                        // Restaura o botão
                        const submitBtn = freepikForm.querySelector('button[type="submit"]');
                        submitBtn.disabled = false;
                        submitBtn.querySelector('.normal-state').classList.remove('hidden');
                        submitBtn.querySelector('.loading').classList.add('hidden');
                        
                        // Atualiza o status
                        fetchAndUpdateStatus();
                    }
                });
            }
            
            // Configura o formulário do Designi
            const designiForm = document.getElementById('designiForm');
            if (designiForm) {
                designiForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const designiLink = document.getElementById('designi_link').value.trim();
                    if (!designiLink) return;
                    
                    try {
                        // Mostra estado de carregamento
                        const submitBtn = designiForm.querySelector('button[type="submit"]');
                        submitBtn.disabled = true;
                        submitBtn.querySelector('.normal-state').classList.add('hidden');
                        submitBtn.querySelector('.loading').classList.remove('hidden');
                        
                        // Envia requisição
                        const response = await fetch('/download_designi', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ url: designiLink })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            console.log('[DESIGNI] Job iniciado:', data);
                            
                            // Adiciona ao histórico
                            const historyItem = addHistoryItem(`
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <img src="https://designistampas.com.br/wp-content/uploads/2020/06/cropped-horizonatalz-192x192.png" alt="Designi" class="platform-icon w-5 h-5 mr-2">
                                        <div>
                                            <p class="font-medium">Processando download</p>
                                            <p class="text-sm opacity-80 truncate max-w-xs">${designiLink}</p>
                                        </div>
                                    </div>
                                    <div class="animate-pulse flex space-x-1">
                                        <div class="w-2 h-2 bg-orange-400 rounded-full"></div>
                                        <div class="w-2 h-2 bg-orange-400 rounded-full"></div>
                                        <div class="w-2 h-2 bg-orange-400 rounded-full"></div>
                                    </div>
                                </div>
                            `, data.job_id);
                            
                            historyItem.classList.add('history-item-pending');
                            
                            // Inicia polling
                            pollJobStatus(data.job_id);
                            
                            // Limpa o formulário
                            document.getElementById('designi_link').value = '';
                            
                        } else {
                            console.error('[DESIGNI] Erro:', data);
                            addHistoryItem(`
                                <div class="alert alert-danger">
                                    <div class="flex items-start">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2 flex-shrink-0 mt-1">
                                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <div>
                                            <p class="font-medium">Erro ao iniciar download</p>
                                            <p class="text-sm opacity-80">${data.error || 'Erro desconhecido'}</p>
                                        </div>
                                    </div>
                                </div>
                            `);
                        }
                    } catch (error) {
                        console.error('[DESIGNI] Erro de rede:', error);
                        addHistoryItem(`
                            <div class="alert alert-danger">
                                <div class="flex items-start">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr-2 flex-shrink-0 mt-1">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <div>
                                        <p class="font-medium">Erro de conexão</p>
                                        <p class="text-sm opacity-80">Não foi possível conectar ao servidor</p>
                                    </div>
                                </div>
                            </div>
                        `);
                    } finally {
                        // Restaura o botão
                        const submitBtn = designiForm.querySelector('button[type="submit"]');
                        submitBtn.disabled = false;
                        submitBtn.querySelector('.normal-state').classList.remove('hidden');
                        submitBtn.querySelector('.loading').classList.add('hidden');
                        
                        // Atualiza o status
                        fetchAndUpdateStatus();
                    }
                });
            }
        });
    </script>
</body>
</html>