<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RapaduraStock</title>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {'primary-accent': '#3b82f6','primary-accent-hover': '#2563eb','primary-accent-glow': 'rgba(59, 130, 246, 0.4)','card-bg': 'rgba(23, 23, 23, 0.6)','card-border': 'rgba(255, 255, 255, 0.1)','input-bg': 'rgba(38, 38, 38, 0.7)','input-border': 'rgba(255, 255, 255, 0.15)','text-main': '#f4f4f5','text-secondary': '#a1a1aa','text-placeholder': '#71717a','success': '#22c55e','danger': '#ef4444',},
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'], },
                    borderRadius: { 'xl': '1rem', 'lg': '0.75rem', },
                     keyframes: { animatedGradient: { '0%': { backgroundPosition: '0% 50%' }, '50%': { backgroundPosition: '100% 50%' }, '100%': { backgroundPosition: '0% 50%' }, }, },
                      animation: { gradient: 'animatedGradient 15s ease infinite', },
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-card { background-color: theme('colors.card-bg', 'rgba(23, 23, 23, 0.6)'); backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%); border: 1px solid theme('colors.card-border', 'rgba(255, 255, 255, 0.1)'); }
        .validation-feedback { font-size: 0.75rem; margin-top: 0.25rem; min-height: 1rem; } .validation-feedback.invalid { color: theme('colors.danger', '#ef4444'); } input.invalid-link { border-color: theme('colors.danger', '#ef4444') !important; }
        #historyItems::-webkit-scrollbar { width: 6px; } #historyItems::-webkit-scrollbar-track { background: transparent; } #historyItems::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); border-radius: 3px; } #historyItems { scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.2) transparent; }
        .btn-glow-hover { transition: background-color 0.2s ease, box-shadow 0.3s ease, transform 0.1s ease; } .btn-glow-hover:hover:not(:disabled) { box-shadow: 0 0 15px 4px theme('colors.primary-accent-glow', 'rgba(59, 130, 246, 0.4)'); } .btn-glow-hover:active:not(:disabled) { transform: scale(0.98); }
        #myTab .nav-link.active { color: theme('colors.primary-accent'); border-color: theme('colors.primary-accent'); }
        .alert { padding: 0.8rem 1rem; border-radius: 0.5rem; border-width: 1px; border-left-width: 4px; } .alert-info { color: #60a5fa; border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); border-left-color: #3b82f6; } .alert-success { color: #4ade80; border-color: #22c55e; background-color: rgba(34, 197, 94, 0.1); border-left-color: #22c55e; } .alert-warning { color: #facc15; border-color: #eab308; background-color: rgba(234, 179, 8, 0.1); border-left-color: #eab308; } .alert-danger { color: #f87171; border-color: #ef4444; background-color: rgba(239, 68, 68, 0.1); border-left-color: #ef4444;} .alert-secondary { color: #a1a1aa; border-color: #71717a; background-color: rgba(113, 113, 122, 0.1); border-left-color: #71717a;}
        .history-item-internal-alert { font-size: 0.875rem; margin-bottom: 0; padding: 0; background-color: transparent; border: none; border-left-width: 3px; padding-left: 0.75rem; }
        .history-item-download-link { display: inline-block; padding: 0.25rem 0.75rem; background-color: theme('colors.primary-accent'); color: white; border-radius: 0.375rem; font-size: 0.75rem; transition: background-color 0.2s ease; margin-top: 0.5rem; font-weight: 500; } .history-item-download-link:hover { background-color: theme('colors.primary-accent-hover'); }
        .history-item-muted-text { color: theme('colors.text-secondary'); font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem; display: block; }
        .btn-submit-loading .spinner-border { width: 1.1em; height: 1.1em; border-width: .2em; margin-right: 0.6em; }
        /* CSS PARA ESTADO DO BOT√ÉO */
        .submit-button.is-normal .loading { display: none; } .submit-button.is-normal .normal-state { display: inline-flex; align-items: center; }
        .submit-button.is-loading .loading { display: inline-flex; align-items: center; } .submit-button.is-loading .normal-state { display: none; }
    </style>
</head>
<body class="bg-zinc-950 text-text-main min-h-screen flex items-center justify-center p-4 animate-gradient">

    <div
        class="w-full max-w-xl"
        x-data="{ loaded: false }"
        x-init="() => { setTimeout(() => { loaded = true }, 100) }"
        x-show="loaded"
        x-transition:enter="transition ease-out duration-500"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
    >
        <div class="glass-card rounded-xl shadow-2xl overflow-hidden">
            <div class="p-6 md:p-8">
                <h1 class="text-2xl md:text-3xl font-bold text-center mb-2 text-text-main">RapaduraStock</h1>
                <p class="text-text-secondary text-center mb-6">Cole seu link Freepik ou Designi para baixar.</p>
                <div id="userStatus" class="mb-6 h-12 flex items-center justify-center"></div>
                <ul class="flex justify-center border-b border-card-border mb-6" id="myTab" role="tablist">
                    <li><button class="nav-link py-3 px-5 border-b-2 border-transparent text-text-secondary hover:text-text-main hover:border-gray-500 transition duration-200 focus:outline-none active" id="freepik-tab" data-bs-toggle="tab" data-bs-target="#freepikTab" type="button" role="tab" aria-controls="freepikTab" aria-selected="true">Freepik</button></li>
                    <li><button class="nav-link py-3 px-5 border-b-2 border-transparent text-text-secondary hover:text-text-main hover:border-gray-500 transition duration-200 focus:outline-none" id="designi-tab" data-bs-toggle="tab" data-bs-target="#designiTab" type="button" role="tab" aria-controls="designiTab" aria-selected="false">Designi</button></li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="freepikTab" role="tabpanel" aria-labelledby="freepik-tab">
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label for="freepik_link" class="block text-sm font-medium text-text-secondary mb-1">Link Freepik</label>
                                <input type="text" id="freepik_link" name="freepik_link" required class="w-full px-4 py-2.5 bg-input-bg border border-input-border rounded-lg text-text-main placeholder-text-placeholder focus:outline-none focus:ring-2 focus:ring-primary-accent focus:border-transparent transition duration-200" placeholder="Cole o link do Freepik aqui...">
                                <div id="freepik_link_feedback" class="validation-feedback"></div>
                            </div>
                            <button type="submit" id="freepikSubmitBtn" class="submit-button is-normal btn-glow-hover w-full flex items-center justify-center px-6 py-3 bg-primary-accent hover:bg-primary-accent-hover rounded-lg text-white font-medium disabled:opacity-50 transition duration-200">
                                <span class="normal-state"><i class="bi bi-cloud-arrow-down-fill mr-2"></i> Baixar do Freepik</span>
                                <span class="loading btn-submit-loading"><span class="spinner-border animate-spin" role="status"></span> Processando...</span>
                            </button>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="designiTab" role="tabpanel" aria-labelledby="designi-tab">
                        <form id="designiForm" onsubmit="downloadDesigni(event)">
                            <div class="mb-3">
                                <label for="designi_link" class="block text-sm font-medium text-text-secondary mb-1">Link Designi</label>
                                <input type="text" id="designi_link" name="designi_link" required class="w-full px-4 py-2.5 bg-input-bg border border-input-border rounded-lg text-text-main placeholder-text-placeholder focus:outline-none focus:ring-2 focus:ring-primary-accent focus:border-transparent transition duration-200" placeholder="Cole o link do Designi aqui...">
                                <div id="designi_link_feedback" class="validation-feedback"></div>
                            </div>
                             <button type="submit" id="designiSubmitBtn" class="submit-button is-normal btn-glow-hover w-full flex items-center justify-center px-6 py-3 bg-primary-accent hover:bg-primary-accent-hover rounded-lg text-white font-medium disabled:opacity-50 transition duration-200">
                                <span class="normal-state"><i class="bi bi-cloud-arrow-down-fill mr-2"></i> Baixar do Designi</span>
                                <span class="loading btn-submit-loading"><span class="spinner-border animate-spin" role="status"></span> Processando...</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

             <div class="px-6 md:px-8 pb-6">
                <div id="uploadHistory" class="mt-6 border-t border-card-border pt-4">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-lg font-medium text-text-secondary">Hist√≥rico Recente</h2>
                         <button id="clearHistoryBtn" class="text-xs text-text-secondary hover:text-red-400 transition duration-200 opacity-75 hover:opacity-100" title="Limpar hist√≥rico do navegador"><i class="bi bi-trash mr-1"></i> Limpar</button>
                    </div>
                    <div id="historyItems" class="space-y-3 max-h-72 overflow-y-auto pr-2"></div>
                </div>
             </div>
        </div>

        <footer class="text-center text-xs text-text-secondary mt-6 opacity-80">
             <div class="mb-2">Feito com <i class="bi bi-heart-fill text-red-500 mx-1"></i> e Rapadura</div>
             <div class="space-x-3 mb-1">
                 <span class="font-medium">Suporte:</span>
                 <a href="mailto:suporte@rapadurastock.com" class="hover:text-primary-accent transition-colors"><i class="bi bi-envelope-fill mr-1"></i>Email</a>
                 <a href="https://www.instagram.com/rapadurastock/" target="_blank" rel="noopener noreferrer" class="hover:text-primary-accent transition-colors"><i class="bi bi-instagram mr-1"></i>Instagram</a>
             </div>
              <div class="opacity-75">Beta v1</div>
        </footer>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Vari√°veis e Constantes Globais
        const activePolls = {};
        const HISTORY_STORAGE_KEY = 'rapaduraStockHistory';
        const MAX_HISTORY_ITEMS = 20;
        const mensagensFun = ["Calma l√°, apressadinho(a)! Limite di√°rio atingido.","Eita! J√° deu por hoje. Volte amanh√£ para mais downloads!","Limite de 2 downloads alcan√ßado. D√™ um descanso pro servidor!","Voc√™ est√° demais! Mas o limite di√°rio j√° foi... tente amanh√£.","Parab√©ns, voc√™ zerou os downloads de hoje! üéâ"];

        // --- Fun√ß√µes Utilit√°rias ---
        function getMensagemFun() { return mensagensFun[Math.floor(Math.random() * mensagensFun.length)]; }

        // --- Fun√ß√µes de Status ---
         function updateStatusDisplay(statusHtml) {
             const userStatus = document.getElementById('userStatus'); if (!userStatus) return;
             if (statusHtml.includes("Voc√™ atingiu o limite") || statusHtml.includes("atingiu o limite")) { const mensagemFun = getMensagemFun(); userStatus.innerHTML = `<div class="alert alert-warning text-sm">${mensagemFun}</div>`; }
             else { if (statusHtml.startsWith('<div')) { userStatus.innerHTML = statusHtml; const alertDiv = userStatus.querySelector('.alert'); if (alertDiv && !alertDiv.classList.contains('alert-danger') && !alertDiv.classList.contains('alert-warning')) { alertDiv.classList.add('text-sm'); } } else { userStatus.innerHTML = `<div class="alert alert-info text-sm">${statusHtml}</div>`; } }
         }
         async function fetchAndUpdateStatus() {
             try { const response = await fetch('/status'); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); const data = await response.text(); updateStatusDisplay(data); }
             catch (error) { console.error('Erro ao carregar status:', error); const userStatus = document.getElementById('userStatus'); if(userStatus) userStatus.innerHTML = '<div class="alert alert-danger text-sm">Erro ao carregar status.</div>';}
         }

        // --- Fun√ß√µes de Hist√≥rico (LocalStorage) ---
        function getHistoryFromStorage() { try { const storedHistory = localStorage.getItem(HISTORY_STORAGE_KEY); return storedHistory ? JSON.parse(storedHistory) : []; } catch (e) { console.error("Erro ao ler hist√≥rico:", e); return []; }}
        function saveHistoryToStorage(historyArray) { try { const limitedHistory = historyArray.slice(0, MAX_HISTORY_ITEMS); localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(limitedHistory)); } catch (e) { console.error("Erro ao salvar hist√≥rico:", e); }}
        function applyStylesToHistoryItem(itemWrapper) {
             const alertEl = itemWrapper.querySelector('.alert'); if(alertEl) { alertEl.classList.add('history-item-internal-alert'); }
             const downloadLink = itemWrapper.querySelector('a.btn'); if(downloadLink) { downloadLink.removeAttribute('class'); downloadLink.classList.add('history-item-download-link'); downloadLink.innerHTML = `<i class="bi bi-download mr-1"></i> Baixar`; }
             const mutedText = itemWrapper.querySelector('.text-muted'); if(mutedText) { mutedText.classList.remove('text-muted', 'small'); mutedText.classList.add('history-item-muted-text'); }
             return itemWrapper;
         }
        function renderHistory() {
             const historyDiv = document.getElementById('historyItems'); if (!historyDiv) return;
             historyDiv.innerHTML = ''; const history = getHistoryFromStorage();
             history.forEach(itemData => {
                 const newItemWrapper = document.createElement('div'); newItemWrapper.className = 'history-item-wrapper bg-zinc-800/60 p-3 md:p-4 rounded-lg border border-zinc-700/60 shadow-sm';
                 if (itemData.id) { newItemWrapper.id = itemData.id; }
                 newItemWrapper.setAttribute('x-data', '{}'); newItemWrapper.innerHTML = itemData.html; applyStylesToHistoryItem(newItemWrapper);
                 historyDiv.appendChild(newItemWrapper);
             });
             if (window.Alpine) { Alpine.initTree(historyDiv); }
         }
        function addHistoryItem(contentHtml, itemId = null) {
            const history = getHistoryFromStorage(); const newItemData = { id: itemId ? `history-item-${itemId}` : `history-item-${Date.now()}`, html: contentHtml };
            history.unshift(newItemData); saveHistoryToStorage(history);
            const historyDiv = document.getElementById('historyItems'); if (!historyDiv) return null;
            const newItemWrapper = document.createElement('div'); newItemWrapper.className = 'history-item-wrapper bg-zinc-800/60 p-3 md:p-4 rounded-lg border border-zinc-700/60 shadow-sm';
            newItemWrapper.id = newItemData.id; newItemWrapper.innerHTML = newItemData.html; applyStylesToHistoryItem(newItemWrapper);
            newItemWrapper.setAttribute('x-data', '{ shown: false }'); newItemWrapper.setAttribute('x-init', 'setTimeout(() => { shown = true }, 50)'); newItemWrapper.setAttribute('x-show', 'shown');
            newItemWrapper.setAttribute('x-transition:enter', 'transition ease-out duration-300'); newItemWrapper.setAttribute('x-transition:enter-start', 'opacity-0 transform -translate-y-2'); newItemWrapper.setAttribute('x-transition:enter-end', 'opacity-100 transform translate-y-0');
            historyDiv.insertBefore(newItemWrapper, historyDiv.firstChild);
            while (historyDiv.children.length > MAX_HISTORY_ITEMS) { historyDiv.removeChild(historyDiv.lastChild); }
            if (window.Alpine) { Alpine.initTree(newItemWrapper); }
            return newItemWrapper;
        }
        function clearHistory() { if (confirm('Tem certeza que deseja limpar todo o hist√≥rico?')) { localStorage.removeItem(HISTORY_STORAGE_KEY); renderHistory(); } }

        // --- Fun√ß√£o de Polling ---
        function pollJobStatus(jobId) {
            console.log(`[POLL] Iniciando polling para Job ID: ${jobId}`); const historyItemWrapper = document.getElementById(`history-item-${jobId}`); if (!historyItemWrapper) return; const historyItemContent = historyItemWrapper;
            const intervalId = setInterval(async () => {
                try {
                    const response = await fetch(`/check_job/${jobId}`); if (!response.ok) { console.error(`[POLL] Erro ${response.status}`); historyItemContent.innerHTML = `<div class="alert alert-danger">‚ùå Erro ${response.status}</div>`; clearInterval(intervalId); delete activePolls[jobId]; return; }
                    const data = await response.json(); console.log(`[POLL] Status ${jobId}:`, data); let finalHtml = null;
                    if (data.status === 'finished') {
                        console.log(`[POLL] Job ${jobId} conclu√≠do!`); clearInterval(intervalId); delete activePolls[jobId];
                        if (data.result && data.result.success) { const result = data.result; finalHtml = `<div class="alert alert-success mb-2">‚úÖ Download Designi conclu√≠do!</div><div class="text-xs md:text-sm space-y-1"><div><strong>Arquivo:</strong> <span class="text-text-main opacity-90">${result.filename || 'N/A'}</span></div><div><strong>ID Google Drive:</strong> <span class="text-text-main opacity-90">${result.file_id || 'N/A'}</span></div><div class="mt-1"><strong>Link:</strong> <a href="${result.download_link}" target="_blank" class="btn"></a></div><div class="text-muted">Dura√ß√£o: ${result.duration_seconds ? result.duration_seconds.toFixed(1) + 's' : 'N/A'}</div></div>`;
                        } else { finalHtml = `<div class="alert alert-warning">‚ö†Ô∏è Falha: ${data.result?.error || data.error || 'Erro tarefa.'}</div>`; }
                        historyItemWrapper.classList.remove('history-item-pending');
                    } else if (data.status === 'failed') { console.log(`[POLL] Job ${jobId} falhou!`); clearInterval(intervalId); delete activePolls[jobId]; finalHtml = `<div class="alert alert-danger">‚ùå Falha cr√≠tica: ${data.error || data.result?.error || 'Erro.'}</div>`; historyItemWrapper.classList.remove('history-item-pending');
                    } else if (['started', 'queued', 'deferred'].includes(data.status)) { console.log(`[POLL] Job ${jobId} status: ${data.status}.`); if (!historyItemWrapper.classList.contains('history-item-pending')) { historyItemWrapper.classList.add('history-item-pending'); const initialMsgHtml = `<div class="alert alert-info history-item-pending"><span class="spinner-border spinner-border-sm animate-spin" role="status" aria-hidden="true"></span> <span class="ml-2">Processando (${data.status})...</span> <span class="text-text-secondary text-xs opacity-75 ml-2">(ID: ${jobId.substring(0, 8)})</span></div>`; historyItemContent.innerHTML = initialMsgHtml; applyStylesToHistoryItem(historyItemContent); saveHistoryToStorage(getHistoryFromStorage()); } else { const statusSpan = historyItemContent.querySelector('.alert span:not(.spinner-border)'); if (statusSpan) statusSpan.textContent = ` Processando (${data.status})...`; }
                    } else { console.warn(`[POLL] Job ${jobId} status inesperado: ${data.status}.`); }
                    if (finalHtml !== null) { historyItemContent.innerHTML = finalHtml; applyStylesToHistoryItem(historyItemContent); const currentHistory = getHistoryFromStorage(); const itemIndex = currentHistory.findIndex(item => item.id === historyItemWrapper.id); if(itemIndex > -1) { currentHistory[itemIndex].html = historyItemContent.innerHTML; saveHistoryToStorage(currentHistory); } }
                } catch (error) { console.error(`[POLL] Erro rede polling ${jobId}:`, error); historyItemContent.innerHTML = `<div class="alert alert-danger">‚ùå Erro comunica√ß√£o.</div>`; clearInterval(intervalId); delete activePolls[jobId]; historyItemWrapper.classList.remove('history-item-pending'); }
            }, 7000);
            activePolls[jobId] = intervalId;
            setTimeout(() => { if (activePolls[jobId]) { console.warn(`[POLL] Timeout ${jobId}.`); clearInterval(activePolls[jobId]); delete activePolls[jobId]; if (historyItemWrapper.classList.contains('history-item-pending')) { historyItemContent.innerHTML = `<div class="alert alert-warning">‚è≥ Timeout verifica√ß√£o.</div>`; historyItemWrapper.classList.remove('history-item-pending'); saveHistoryToStorage(getHistoryFromStorage());} } }, 10 * 60 * 1000);
        }

        // --- Fun√ß√µes de Download (Designi e Freepik) com Corre√ß√£o de Estado do Bot√£o ---
        async function downloadDesigni(event) {
            event.preventDefault(); const form = document.getElementById('designiForm'); const linkInput = document.getElementById('designi_link'); const link = linkInput.value; const submitButton = form.querySelector('button[type="submit"]');
            if (!link || !isValidDesigniLink(link)) { setLinkValidity('designi', false, 'Link inv√°lido.'); return; }
            setLinkValidity('designi', true);
            submitButton.disabled = true; submitButton.classList.remove('is-normal'); submitButton.classList.add('is-loading'); // Muda estado visual
            try { const response = await fetch('/download-designi', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: link }) });
                let responseData = {}; try { responseData = await response.json(); } catch (e) {}
                if (response.status === 429) { addHistoryItem(`<div class="alert alert-warning">‚úã ${responseData.error || 'Limite atingido.'}</div>`); await fetchAndUpdateStatus(); return; }
                else if (!response.ok) { addHistoryItem(`<div class="alert alert-danger">‚ùå Erro: ${responseData.error || `HTTP ${response.status}`}</div>`); await fetchAndUpdateStatus(); return; }
                if (responseData.success && responseData.job_id) { const initialMsgHtml = `<div class="alert alert-info history-item-pending"><span class="spinner-border spinner-border-sm animate-spin" role="status" aria-hidden="true"></span> <span class="ml-2">${responseData.message || 'Iniciado...'}</span> <span class="text-text-secondary text-xs opacity-75 ml-2">(ID: ${responseData.job_id.substring(0, 8)})</span></div>`; const newItem = addHistoryItem(initialMsgHtml, responseData.job_id); if(newItem) newItem.classList.add('history-item-pending'); linkInput.value = ''; setLinkValidity('designi', true); pollJobStatus(responseData.job_id); }
                else { addHistoryItem(`<div class="alert alert-danger">‚ùå Erro: ${responseData.error || 'Resposta inesperada.'}</div>`); }
                await fetchAndUpdateStatus();
            } catch (error) { console.error('Erro fetch /download-designi:', error); addHistoryItem(`<div class="alert alert-danger">‚ùå Erro: ${error.message}</div>`); }
            finally { submitButton.disabled = false; submitButton.classList.remove('is-loading'); submitButton.classList.add('is-normal'); } // Restaura estado visual e funcional
         }
        document.getElementById('uploadForm').addEventListener('submit', async function(event) {
            event.preventDefault(); const form = this; const linkInput = document.getElementById('freepik_link'); const submitButton = form.querySelector('button[type="submit"]');
             if (!linkInput.value || !isValidFreepikLink(linkInput.value)) { setLinkValidity('freepik', false, 'Link inv√°lido.'); return; }
             setLinkValidity('freepik', true);
             submitButton.disabled = true; submitButton.classList.remove('is-normal'); submitButton.classList.add('is-loading'); // Muda estado visual
            try { const response = await fetch('/upload', { method: 'POST', body: new FormData(form) }); const dataHtml = await response.text();
                 if (response.status === 429 || !response.ok) { addHistoryItem(dataHtml || `<div class="alert alert-danger">‚ùå Erro ${response.status}.</div>`); await fetchAndUpdateStatus(); /* finally cuidar√° do bot√£o */ return; }
                 else { addHistoryItem(dataHtml); if (dataHtml.includes('alert-success') || dataHtml.includes('Upload conclu√≠do')) { linkInput.value = ''; setLinkValidity('freepik', true);} await fetchAndUpdateStatus(); }
            } catch (error) { console.error('Erro fetch /upload:', error); addHistoryItem(`<div class="alert alert-danger">‚ùå Erro: ${error.message}</div>`); }
            finally { submitButton.disabled = false; submitButton.classList.remove('is-loading'); submitButton.classList.add('is-normal'); } // Restaura estado visual e funcional
        });

        // --- Valida√ß√£o de Link no Cliente ---
        function isValidFreepikLink(url) { const freepikRegex = /^https?:\/\/(?:www\.)?freepik\.(?:com|es)\/(?:photo|vector|psd|icon|ai-image|video)\/[^/]+_(\d+)\.(?:htm|jpg)/; return freepikRegex.test(url); }
        function isValidDesigniLink(url) { return url.startsWith('https://www.designi.com.br/'); }
        function setLinkValidity(type, isValid, message = '') {
            const input = document.getElementById(`${type}_link`); const feedback = document.getElementById(`${type}_link_feedback`); const button = document.getElementById(`${type}SubmitBtn`);
            if (!input || !feedback || !button) return;
            const isInputEmpty = input.value.trim() === '';
            if (isValid || isInputEmpty) { input.classList.remove('invalid-link'); feedback.textContent = ''; feedback.classList.remove('invalid'); button.disabled = isInputEmpty; }
            else { input.classList.add('invalid-link'); feedback.textContent = message; feedback.classList.add('invalid'); button.disabled = true; }
        }
        document.getElementById('freepik_link').addEventListener('input', (e) => { setLinkValidity('freepik', isValidFreepikLink(e.target.value), 'Link Freepik parece inv√°lido.'); });
        document.getElementById('designi_link').addEventListener('input', (e) => { setLinkValidity('designi', isValidDesigniLink(e.target.value), 'Link Designi deve come√ßar com https://www.designi.com.br/'); });

        // --- Event Listeners e Inicializa√ß√£o ---
        document.addEventListener('DOMContentLoaded', () => {
             fetchAndUpdateStatus(); renderHistory();
             const clearBtn = document.getElementById('clearHistoryBtn'); if (clearBtn) { clearBtn.addEventListener('click', clearHistory); }
             const fInput = document.getElementById('freepik_link'); const dInput = document.getElementById('designi_link');
             setLinkValidity('freepik', isValidFreepikLink(fInput.value), 'Link Freepik parece inv√°lido.');
             setLinkValidity('designi', isValidDesigniLink(dInput.value), 'Link Designi deve come√ßar com https://www.designi.com.br/');
             // Garante estado inicial correto dos bot√µes
             document.querySelectorAll('.submit-button').forEach(button => {
                 const form = button.closest('form');
                 const input = form ? form.querySelector('input[required]') : null;
                 button.disabled = input ? input.value.trim() === '' : false; // Desabilita se input vazio
                 button.classList.add('is-normal');
                 button.classList.remove('is-loading');
             });
        });

    </script>
    </body>
</html>